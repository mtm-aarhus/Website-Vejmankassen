{% extends "common.html" %}

<style>
  .row-highlight {
    outline: 2px solid rgba(0,0,0,.25);
  }

  .status-badge {
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
  }

  .status-open { background: #dc3545; color: white; }
  .status-auto { background: #6c757d; color: white; }
  .status-user { background: #0d6efd; color: white; }
  .status-manual { background: #198754; color: white; }
</style>

{% block content %}

<div id="issues-toolbar" class="d-flex gap-2">
    <select id="filterMine" class="form-select form-select-sm" style="width: 160px;">
      <option value="all">Alle konflikter</option>
      <option value="mine">Mine konflikter</option>
    </select>

    <select id="filterStatus" class="form-select form-select-sm" style="width: 160px;">
      <option value="">Alle statusser</option>
      <option value="Open">Åbne</option>
      <option value="AutoResolved">Løst</option>
      <option value="UserAccepted">Accepteret af bruger</option>
    </select>

    <button id="btnRefresh" class="btn btn-sm btn-secondary">
      <i class="bi bi-arrow-repeat"></i>
    </button>
</div>


<div class="table-responsive">
  <table
      id="issues-table"
      class="table table-striped table-bordered align-middle"
      data-toggle="table"
      data-url="{{ url_for('api_issues') }}"
      data-toolbar="#issues-toolbar"
      data-pagination="true"
      data-side-pagination="server"
      data-search="true"
      data-page-size="10"
      data-page-list="[10, 25, 50, 100]"
      data-total-field="total"
      data-data-field="rows"
      data-unique-id="IssueID">

      <thead>
  <tr>
    <th data-field="Tilladelsesnr" data-formatter="linkFormatter">Tilladelse</th>
    <th data-field="IssueType">Type</th>
    <th data-field="Fakturalinje">Fakturalinje</th>
    <th data-field="IssueDescription">Beskrivelse</th>
    <th data-field="SuggestedFix">Løsning</th>
    <th data-field="ShortEmail">Sagsbehandler</th>
    <th data-field="Status" data-formatter="statusFormatter">Status</th>
    <th data-field="IssueID" data-formatter="actionFormatter" data-events="issueEvents">Handling</th>
  </tr>
</thead>


  </table>
</div>

{% endblock %}

{% block extra_js %}
<script>

//
// --- Status Badge ---
//
function statusFormatter(value) {
  if (!value) return '';

  if (value === 'Open')
    return '<span class="status-badge status-open">Åben</span>';

  if (value === 'AutoResolved')
    return '<span class="status-badge status-auto">Auto</span>';

  if (value === 'UserAccepted')
    return '<span class="status-badge status-user">Accepteret</span>';

  return value;
}

//
// --- Action buttons ---
//
function actionFormatter(value, row) {
  const canEdit = {{ (user_is_admin or user_is_sags) | tojson }};
  const allowedTypes = [
    "Længde/m2 stemmer ikke",
    "Antal dage stemmer ikke"
  ];

  if (!canEdit) return "";

  // 1. UserAccepted → user can unresolve it
  if (row.Status === "UserAccepted") {
    return `
      <button class="btn btn-sm btn-warning unresolve-btn" data-id="${row.IssueID}">
        <i class="bi bi-arrow-counterclockwise"></i> Markér som uløst
      </button>
    `;
  }

  // 2. Not Open → nothing to show
  if (row.Status !== "Open") {
    return "";
  }

  // 3. Open + allowed → user can manually resolve
  if (allowedTypes.includes(row.IssueType)) {
    return `
      <button class="btn btn-sm btn-success resolve-btn" data-id="${row.IssueID}">
        <i class="bi bi-check2-circle"></i> Accepter konflikt
      </button>
    `;
  }

  // 4. Open but NOT allowed → show informational Vejman message
  return `
    <span class="text-muted small">
      Ret i vejman
    </span>
  `;
}

//
// --- Event handler ---
//
window.issueEvents = {
  'click .resolve-btn': function (e, value, row) {

    const $table = $('#issues-table');
    const $tr = $table.find('tr[data-uniqueid="' + row.IssueID + '"]');

    // Highlight row
    $tr.addClass('table-warning row-highlight');

    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        const ok = confirm('Vil du acceptere konflikten? Hvis du har rettet problemet i Vejman, skal du ikke acceptere konflikten. Linjen bliver automatisk løst ved næste opdatering. Vælg kun "OK" hvis konflikten ikke kan løses i Vejman, og du har tjekket og/eller rettet linjen i Vejmankassen. ');

        if (!ok) {
          $tr.removeClass('table-warning row-highlight');
          return;
        }

        fetch('/api/issues/resolve/' + row.IssueID, {
          method: 'POST',
          headers: { 'X-CSRFToken': '{{ csrf_token() }}' }
        })
          .then(r => r.json())
          .then(json => {
            if (!json.success) throw new Error(json.error || 'Ukendt fejl');

            // Remove or refresh row
            $table.bootstrapTable('refresh');
          })
          .catch(err => {
            alert('Kunne ikke markere som løst: ' + err.message);
            $tr.removeClass('table-warning row-highlight');
          });
      });
    });
  }
};

window.issueEvents['click .unresolve-btn'] = function (e, value, row) {
  const $table = $('#issues-table');
  const $tr = $table.find('tr[data-uniqueid="' + row.IssueID + '"]');

  if (!confirm("Markér konflikten som uløst?")) return;

  fetch('/api/issues/unresolve/' + row.IssueID, {
    method: 'POST',
    headers: { 'X-CSRFToken': '{{ csrf_token() }}' }
  })
    .then(r => r.json())
    .then(json => {
      if (!json.success) throw new Error(json.error || 'Ukendt fejl');
      $table.bootstrapTable('refresh');
    })
    .catch(err => alert('Fejl: ' + err.message));
};


//
// --- Filters ---
//
function refreshIssues() {
  const mine = $('#filterMine').val() === 'mine';
  const status = $('#filterStatus').val();

  $('#issues-table').bootstrapTable('refresh', {
    query: {
      mine: mine ? 'true' : '',
      status: status || ''
    }
  });
}

$('#filterMine').on('change', refreshIssues);
$('#filterStatus').on('change', refreshIssues);
$('#btnRefresh').on('click', refreshIssues);

document.addEventListener("DOMContentLoaded", function () {
    // Set dropdown to Uløste
    $('#filterStatus').val('Open');

    // Wait until the table first loads, then force refresh
    $('#issues-table').one('load-success.bs.table', function () {
        refreshIssues();
    });
});

</script>
{% endblock %}
