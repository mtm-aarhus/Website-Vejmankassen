<!-- templates/tilfakturering.html -->
{% extends "common.html" %}
<style>
  .row-highlight {
    outline: 2px solid rgba(0,0,0,.25);
  }
</style>

{% block content %}
  <div class="table-responsive">
    <table
      id="tf-table"
      class="table table-striped table-bordered align-middle"
      data-toggle="table"
      data-pagination="true"
      data-side-pagination="server"
      data-search="true"
      data-url="{{ url_for('tilfakturering_data') }}"
      data-page-size="10"
      data-page-list="[10, 25, 50, 100]"
      data-sort-name="Slutdato"
      data-sort-order="desc"
      data-total-field="total"
      data-data-field="rows"
      data-unique-id="ID">
      <thead>
        <tr>

          <th data-field="ID" data-formatter="undoFormatter" data-events="undoEvents" data-switchable="false"></th>
          <th data-field="Ansøger" data-sortable="true">Ansøger</th>
          <th data-field="Adresse" data-sortable="true">Adresse</th>
          <th data-field="Tilladelsesnr" data-formatter="linkFormatter" data-sortable="true">Tilladelse</th>
          <th data-field="CvrNr" data-sortable="true">CVR</th>
          <th data-field="TilladelsesType" data-sortable="true">Type</th>
          <th data-field="Enhedspris" data-sortable="true">Enhed</th>
          <th data-field="Meter" data-sortable="true">Meter</th>
          <th data-field="Startdato" data-sortable="true">Startdato</th>
          <th data-field="Slutdato" data-sortable="true">Slutdato</th>
          <th data-field="AntalDage" data-sortable="true">Dage</th>
          <th data-field="TotalPris" data-sortable="true">Pris</th>
        </tr>
      </thead>
    </table>
  </div>
{% endblock %}

{% block extra_js %}
<script>
  
function undoFormatter(value, row) {
  const canEdit = {{ (user_is_admin or user_is_sags) | tojson }};

  return (
    '<button type="button" class="btn btn-sm btn-warning undo-btn"'
      + ' data-id="' + row.ID + '"'
      + ' title="Fortryd fakturering" aria-label="Fortryd fakturering"'
      + (canEdit ? '' : ' disabled')
      + '>'
      + '<i class="bi bi-arrow-counterclockwise"></i>'
    + '</button>'
  );
}


  window.undoEvents = {
    'click .undo-btn': function (e, value, row) {
      const $table = $('#tf-table'); // adjust if your table has a different id
      const $tr = $table.find('tr[data-uniqueid="' + row.ID + '"]');

      // Add highlight (combine with Bootstrap's table-warning for a yellow fill)
      $tr.addClass('table-warning row-highlight');

      // Let the browser paint, then show the blocking confirm dialog
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          const ok = confirm('Fortryd "Send til fakturering" for denne linje?');

          if (!ok) {
            // User cancelled: remove highlight
            $tr.removeClass('table-warning row-highlight');
            return;
          }

          // Proceed with the undo call
          fetch('/api/tilfakturering/fortryd/' + row.ID, { method: 'POST' })
            .then(r => r.json())
            .then(json => {
              if (!json.success) throw new Error(json.error || 'Ukendt fejl');
              // Remove the row from the table (highlight will disappear with it)
              $table.bootstrapTable('removeByUniqueId', row.ID);
            })
            .catch(err => {
              alert('Kunne ikke fortryde: ' + err.message);
              // Keep user context but clear the highlight since action failed
              $tr.removeClass('table-warning row-highlight');
            });
        });
      });
    }
  };
</script>
{% endblock %}
