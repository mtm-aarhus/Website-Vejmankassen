{# templates/ikkefaktureret.html #}
{% extends "common.html" %}

{% block extra_head %}{% endblock %}

{% block content %}
<div class="table-responsive">
  <table
    id="vf-table"
    class="table table-striped table-bordered align-middle"
    data-toggle="table"
    data-pagination="true"
    data-side-pagination="server"
    data-search="true"
    data-url="{{ url_for('ikkefaktureret_data') }}"
    data-page-size="10"
    data-page-list="[10, 25, 50, 100]"
    data-sort-name="Slutdato"
    data-sort-order="desc"
    data-total-field="total"
    data-data-field="rows"
    data-unique-id="ID">
    <thead>
      <tr>
        <th data-field="ID" data-formatter="editFormatter" data-events="editEvents" data-switchable="false"></th>
        <th data-field="Ansøger" data-sortable="true">Ansøger</th>
        <th data-field="Adresse" data-sortable="true">Adresse</th>
        <th data-field="Tilladelsesnr" data-formatter="linkFormatter" data-sortable="true">Tilladelse</th>
        <th data-field="CvrNr" data-sortable="true">CVR</th>
        <th data-field="TilladelsesType" data-sortable="true">Type</th>
        <th data-field="Enhedspris" data-sortable="true">Enhed</th>
        <th data-field="Meter" data-sortable="true">Meter</th>
        <th data-field="Startdato" data-sortable="true">Startdato</th>
        <th data-field="Slutdato" data-sortable="true">Slutdato</th>
        <th data-field="AntalDage" data-sortable="true">Dage</th>
        <th data-field="TotalPris" data-sortable="true">Pris</th>
      </tr>
    </thead>
  </table>
</div>

<!-- Edit Modal (unchanged) -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Redigér fakturalinje</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Luk"></button>
      </div>
      <div class="modal-body">
        <form id="editForm" class="row g-3">
          <input type="hidden" id="edit-ID">

          <div class="col-md-3">
            <label class="form-label">VejmanID</label>
            <input type="text" class="form-control" id="edit-VejmanID" disabled>
          </div>
          <div class="col-md-3">
            <label class="form-label">Tilladelsesnr</label>
            <input type="text" class="form-control" id="edit-Tilladelsesnr" disabled>
          </div>
          <div class="col-md-3">
            <label class="form-label">CVR</label>
            <input type="text" class="form-control" id="edit-CvrNr" disabled>
          </div>

          <div class="col-md-3">
            <label class="form-label">Enhedspris</label>
            <input type="text" class="form-control" id="edit-Enhedspris" disabled>
          </div>

          <div class="col-md-4">
            <label class="form-label">Ansøger</label>
            <input type="text" class="form-control" id="edit-Ansøger" disabled>
          </div>

          <div class="col-md-4">
            <label class="form-label">Adresse</label>
            <input type="text" class="form-control" id="edit-Adresse" disabled>
          </div>

          <div class="col-md-4">
            <label class="form-label">Type</label>
            <input type="text" class="form-control" id="edit-TilladelsesType" disabled>
          </div>

          <hr class="mt-2">

          <!-- Editable -->
          <div class="col-md-4">
            <label for="edit-Meter" class="form-label">Meter</label>
            <input type="text"
                   class="form-control"
                   id="edit-Meter"
                   inputmode="decimal"
                   pattern="^\d+([.,]\d{1,2})?$"
                   placeholder="1,5"
                   required
                   {% if not (user_is_admin or user_is_sags) %}readonly{% endif %}>
          </div>
          <div class="col-md-4">
            <label for="edit-Startdato" class="form-label">Startdato</label>
            <input type="date" class="form-control" id="edit-Startdato" {% if not (user_is_admin or user_is_sags) %}readonly{% endif %} required>
          </div>
          <div class="col-md-4">
            <label for="edit-Slutdato" class="form-label" >Slutdato</label>
            <input type="date" class="form-control" id="edit-Slutdato" {% if not (user_is_admin or user_is_sags) %}readonly{% endif %} required>
          </div>

          <!-- Calculated -->
          <div class="col-md-3">
            <label class="form-label">Antal dage</label>
            <input type="text" class="form-control" id="edit-AntalDage" disabled>
          </div>
          <div class="col-md-3">
            <label class="form-label">Total pris</label>
            <input type="text" class="form-control" id="edit-TotalPris" disabled>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" 
                class="btn btn-danger me-auto" 
                id="markDoNotInvoiceBtn"
                data-bs-toggle="tooltip" 
                data-bs-placement="top" 
                title="Skjuler fakturalinjen fra Vejmankassen så den ikke bliver faktureret ved en fejl">
          Fakturer ikke
        </button>

        <small id="calcHint" class="text-muted"></small>

        <button type="button" 
                class="btn btn-primary" 
                id="saveEditBtn"
                data-bs-toggle="tooltip" 
                data-bs-placement="top" 
                title="Gem ændringer som kladde">
          Gem
        </button>
        
        <button type="button" 
                class="btn btn-success" 
                id="sendForBillingBtn"
                data-bs-toggle="tooltip" 
                data-bs-placement="top" 
                title="Sender linjen videre til fakturering">
          Send til fakturering
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>

    // Edit button uses default Bootstrap button + Bootstrap Icon
    function editFormatter(value, row) {
      return (
        '<button type="button" class="btn btn-sm btn-primary edit-btn"'
        + ' data-id="' + row.ID + '" title="Redigér" aria-label="Redigér">'
        +   '<i class="bi bi-pencil-square"></i>'
        + '</button>'
      );
    }

    // Format with Danish comma, round to max 2 decimals, trim trailing zeros
    function formatDkNumber(x, maxDecimals = 2) {
      if (x == null || x === '') return '';
      const num = Number(String(x).replace(',', '.'));
      if (!isFinite(num)) return '';
      const factor = Math.pow(10, maxDecimals);
      const rounded = Math.round(num * factor) / factor;
      let s = rounded.toString();
      if (s.includes('.')) s = s.replace(/\.?0+$/, '');
      return s.replace('.', ',');
    }

    function parseNumber(s) {
      if (s == null || s === '') return NaN;
      return Number(String(s).replace(',', '.'));
    }

    function isMeterValid() {
      const el = document.getElementById('edit-Meter');
      // Use native validity (pattern + required)
      if (!el.checkValidity()) return false;
      const n = parseNumber(el.value);
      return isFinite(n);
    }

    function datesPresentAndValid() {
      const s = document.getElementById('edit-Startdato').value;
      const e = document.getElementById('edit-Slutdato').value;
      if (!s || !e) return false;
      const sd = new Date(s), ed = new Date(e);
      if (isNaN(sd.getTime()) || isNaN(ed.getTime())) return false;
      return ed.getTime() >= sd.getTime();
    }

  function setButtonsEnabled(enabled) {
    if (!CAN_EDIT) return; // <-- do not enable if role is BI

    const saveBtn  = document.getElementById('saveEditBtn');
    const sendBtn  = document.getElementById('sendForBillingBtn');
    const noInvBtn = document.getElementById('markDoNotInvoiceBtn');

    [saveBtn, sendBtn, noInvBtn].forEach(btn => { 
        if (btn) btn.disabled = !enabled;
    });
  }
    function recalc() {
      const start = document.getElementById('edit-Startdato').value; // yyyy-mm-dd
      const slut  = document.getElementById('edit-Slutdato').value;  // yyyy-mm-dd
      const meterVal = document.getElementById('edit-Meter').value;
      const enhedspris = parseNumber(document.getElementById('edit-Enhedspris').value);

      const hint = document.getElementById('calcHint');
      hint.textContent = '';

      let dage = '';
      let totalStr = '';

      const meterOk = isMeterValid();
      const bothDatesEntered = !!start && !!slut;

      if (!bothDatesEntered) {
        hint.textContent = 'Udfyld både start- og slutdato.';
        setButtonsEnabled(false);
      }

      if (bothDatesEntered && !meterOk) {
        hint.textContent = 'Meter skal være et gyldigt tal med op til 2 decimaler (fx 1,5).';
        setButtonsEnabled(false);
      }

      if (bothDatesEntered) {
        const sd = new Date(start);
        const ed = new Date(slut);
        if (ed < sd) {
          hint.textContent = 'Slutdato skal være samme dag eller senere end startdato.';
          setButtonsEnabled(false);
        } else {
          if (meterOk) {
            const diffMs = ed.getTime() - sd.getTime();
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24)) + 1; // +1 inclusive
            dage = diffDays;

            const meter = parseNumber(meterVal);
            if (!isNaN(meter) && !isNaN(enhedspris)) {
              const rawTotal = enhedspris * meter * diffDays;
              totalStr = formatDkNumber(rawTotal, 2);
            }
            setButtonsEnabled(true);
          }
        }
      }

      document.getElementById('edit-AntalDage').value = dage === '' ? '' : String(dage);
      document.getElementById('edit-TotalPris').value = totalStr === '' ? '' : totalStr;
    }

    // ---------- Modal instance & lifecycle (prevents stuck backdrop) ----------
    const modalEl   = document.getElementById('editModal');
    const editModal = bootstrap.Modal.getOrCreateInstance(modalEl, {
      backdrop: true,
      keyboard: true,
      focus: true
    });

    // Avoid transient aria-hidden warnings and ensure cleanup
    modalEl.addEventListener('shown.bs.modal', () => {
      modalEl.removeAttribute('aria-hidden');
    });

    modalEl.addEventListener('hidden.bs.modal', () => {
      // Fallback cleanup if anything got stuck during debugging/breakpoints
      document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());
      document.body.classList.remove('modal-open');
      document.body.style.removeProperty('padding-right');
    });

    function withHiddenOnce(cb) {
      const handler = () => {
        modalEl.removeEventListener('hidden.bs.modal', handler);
        cb();
      };
      modalEl.addEventListener('hidden.bs.modal', handler);
    }

    function openEdit(rowId) {
      if (modalEl.classList.contains('show')) return; // prevent double-open
      // fetch happens in the event below, then we show after fields are filled
    }
    // -------------------------------------------------------------------------

    window.editEvents = {
      'click .edit-btn': function (e, value, row) {
        openEdit(row.ID);
        fetch('/api/fakturering/' + row.ID)
          .then(r => r.json())
          .then(json => {
            if (!json.success) throw new Error(json.error || 'Ukendt fejl');
            const d = json.data;

            // Fill read-only-as-form controls
            document.getElementById('edit-ID').value = d.ID ?? '';
            document.getElementById('edit-VejmanID').value = d.VejmanID ?? '';
            document.getElementById('edit-Tilladelsesnr').value = d.Tilladelsesnr ?? '';
            document.getElementById('edit-Ansøger').value = d.Ansøger ?? '';
            document.getElementById('edit-Adresse').value = d.Adresse ?? '';
            document.getElementById('edit-CvrNr').value = d.CvrNr ?? '';
            document.getElementById('edit-TilladelsesType').value = d.TilladelsesType ?? '';
            document.getElementById('edit-Enhedspris').value = d.Enhedspris ?? '';

            // Editable inputs
            document.getElementById('edit-Meter').value = d.Meter || '';
            document.getElementById('edit-Startdato').value = d.Startdato || '';
            document.getElementById('edit-Slutdato').value  = d.Slutdato || '';

            // Initial calc + validation state
            recalc();

            // Disable buttons for BI
            const saveBtn  = document.getElementById('saveEditBtn');
            const sendBtn  = document.getElementById('sendForBillingBtn');
            const noInvBtn = document.getElementById('markDoNotInvoiceBtn');

            if (!CAN_EDIT) {
                saveBtn.disabled = true;
                sendBtn.disabled = true;
                noInvBtn.disabled = true;
            }

            editModal.show(); // reuse single instance
          })
          .catch(err => alert('Fejl ved hentning af data: ' + err));
      }
    };

    // Recalc on user edits (no sanitizing; rely on pattern/required)
    ['edit-Meter','edit-Startdato','edit-Slutdato'].forEach(id => {
      document.addEventListener('input', e => { if (e.target && e.target.id === id) recalc(); });
      document.addEventListener('change', e => { if (e.target && e.target.id === id) recalc(); });
    });

    // Save (only editable fields) -> update the row AFTER modal fully closes
    document.getElementById('saveEditBtn').addEventListener('click', function() {
      const payload = {
        ID: document.getElementById('edit-ID').value,
        Meter: document.getElementById('edit-Meter').value,
        Startdato: document.getElementById('edit-Startdato').value, // yyyy-mm-dd
        Slutdato: document.getElementById('edit-Slutdato').value   // yyyy-mm-dd
      };

      // Prevent rapid double-clicks while saving
      ['saveEditBtn','sendForBillingBtn','markDoNotInvoiceBtn'].forEach(id => {
        const b = document.getElementById(id);
        if (b) b.disabled = true;
      });

      fetch('/update', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
        .then(r => r.json())
        .then(json => {
          if (!json.success) {
            const msg = json.errors ? json.errors.join('\n') : 'Ukendt fejl';
            alert('Kunne ikke opdatere:\n' + msg);
            // re-enable
            ['saveEditBtn','sendForBillingBtn','markDoNotInvoiceBtn'].forEach(id => {
              const b = document.getElementById(id);
              if (b) b.disabled = false;
            });
            return;
          }
          withHiddenOnce(() => {
            if (json.data && json.data.ID != null) {
              $('#vf-table').bootstrapTable('updateByUniqueId', { id: json.data.ID, row: json.data });
            } else {
              $('#vf-table').bootstrapTable('refresh');
            }
          });
          editModal.hide();
        })
        .catch(err => {
          alert('Fejl ved opdatering: ' + err);
          ['saveEditBtn','sendForBillingBtn','markDoNotInvoiceBtn'].forEach(id => {
            const b = document.getElementById(id);
            if (b) b.disabled = false;
          });
        });
    });

    // Send til fakturering -> remove row AFTER modal fully closes
    document.getElementById('sendForBillingBtn').addEventListener('click', function() {
      const payload = {
        ID: document.getElementById('edit-ID').value,
        Meter: document.getElementById('edit-Meter').value,
        Startdato: document.getElementById('edit-Startdato').value,
        Slutdato: document.getElementById('edit-Slutdato').value,
        SendTilFakturering: true
      };

      ['saveEditBtn','sendForBillingBtn','markDoNotInvoiceBtn'].forEach(id => {
        const b = document.getElementById(id);
        if (b) b.disabled = true;
      });

      fetch('/update', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
        .then(r => r.json())
        .then(json => {
          if (!json.success) {
            const msg = json.errors ? json.errors.join('\n') : 'Ukendt fejl';
            alert('Kunne ikke sende til fakturering:\n' + msg);
            ['saveEditBtn','sendForBillingBtn','markDoNotInvoiceBtn'].forEach(id => {
              const b = document.getElementById(id);
              if (b) b.disabled = false;
            });
            return;
          }
          withHiddenOnce(() => {
            if (json.data && json.data.ID != null) {
              $('#vf-table').bootstrapTable('removeByUniqueId', json.data.ID);
            } else {
              $('#vf-table').bootstrapTable('refresh');
            }
          });
          editModal.hide();
        })
        .catch(err => {
          alert('Fejl ved opdatering: ' + err);
          ['saveEditBtn','sendForBillingBtn','markDoNotInvoiceBtn'].forEach(id => {
            const b = document.getElementById(id);
            if (b) b.disabled = false;
          });
        });
    });

    // Fakturer ikke (red, left) -> remove row AFTER modal fully closes
    document.getElementById('markDoNotInvoiceBtn').addEventListener('click', function() {
      const payload = {
        ID: document.getElementById('edit-ID').value,
        Meter: document.getElementById('edit-Meter').value,
        Startdato: document.getElementById('edit-Startdato').value,
        Slutdato: document.getElementById('edit-Slutdato').value,
        FakturerIkke: 1
      };

      ['saveEditBtn','sendForBillingBtn','markDoNotInvoiceBtn'].forEach(id => {
        const b = document.getElementById(id);
        if (b) b.disabled = true;
      });

      fetch('/update', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
        .then(r => r.json())
        .then(json => {
          if (!json.success) {
            const msg = json.errors ? json.errors.join('\n') : 'Ukendt fejl';
            alert('Kunne ikke markere som "Fakturer ikke":\n' + msg);
            ['saveEditBtn','sendForBillingBtn','markDoNotInvoiceBtn'].forEach(id => {
              const b = document.getElementById(id);
              if (b) b.disabled = false;
            });
            return;
          }
          withHiddenOnce(() => {
            if (json.data && json.data.ID != null) {
              $('#vf-table').bootstrapTable('removeByUniqueId', json.data.ID);
            } else {
              $('#vf-table').bootstrapTable('refresh');
            }
          });
          editModal.hide();
        })
        .catch(err => {
          alert('Fejl ved opdatering: ' + err);
          ['saveEditBtn','sendForBillingBtn','markDoNotInvoiceBtn'].forEach(id => {
            const b = document.getElementById(id);
            if (b) b.disabled = false;
          });
        });
    });
  </script>

{% endblock %}